version: 2.1

executors:
  php-node-executor:
    docker:
      - image: cimg/php:8.2-node
    working_directory: ~/repo

  node-executor:
    docker:
      - image: cimg/node:20.17.0
    working_directory: ~/repo

services:
  mysql:
    image: mysql:5.7
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: invoicy_db
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      retries: 5
      start_period: 5s
      timeout: 10s

jobs:
  test_backend:
    executor: php-node-executor
    steps:
      - checkout
      - run:
          name: Vérifier le contenu du dépôt après checkout
          command: ls -lR
      - run:
          name: Vérifier le contenu du dossier backend
          command: ls -l backend
      - run:
          name: Générer le fichier .env
          command: cp backend/.env.local backend/.env
      - run:
          name: Installer les dépendances PHP
          command: |
            cd backend
            composer install
      - run:
          name: Exécuter les tests PHPUnit
          command: |
            cd backend
            ./vendor/bin/php-cs-fixer fix tests
            ./vendor/bin/php-cs-fixer fix src

  build_backend:
    executor: php-node-executor
    steps:
      - checkout
      - run:
          name: Installer le client MySQL avec les bons privilèges
          command: |
            sudo apt-get update
            sudo apt-get install -y mysql-client
      - run:
          name: Vérifier si la base de données est prête
          command: |
            until mysql -h 127.0.0.1 -u root -proot -e "SHOW DATABASES;" 2>/dev/null; do
              echo "Attente de MySQL..."
              sleep 5
            done
            echo "MySQL est prêt !"
      - run:
          name: Installer les dépendances Composer
          command: |
            cd backend
            composer install
      - run:
          name: Exécuter le nettoyage du cache et les migrations Doctrine
          command: |
            cd backend
            php bin/console cache:clear
            php bin/console doctrine:migrations:migrate --no-interaction

  test_frontend:
    executor: node-executor
    steps:
      - checkout
      - run:
          name: Vérifier le contenu du dépôt après checkout
          command: ls -lR
      - run:
          name: Vérifier le contenu du frontend
          command: ls -l frontend
      - run:
          name: Installer les dépendances Node.js
          command: |
            cd frontend
            npm install
            npm audit fix
      - run:
          name: Exécuter les tests Jest
          command: |
            cd frontend
            npm run test

  build_frontend:
    executor: node-executor
    steps:
      - checkout
      - run:
          name: Installer les dépendances Node.js
          command: |
            cd frontend
            npm install
      - run:
          name: Build du frontend Next.js
          command: |
            cd frontend
            npm run build

workflows:
  version: 2
  pipeline:
    jobs:
      - test_backend
      - test_frontend
      - build_backend:
          requires:
            - test_backend
      - build_frontend:
          requires:
            - test_frontend
